<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marina | TidePool Donor Impact Agent</title>
<style>
  :root {
    --ocean: #0a3d2e;
    --ocean-mid: #1a6b4a;
    --ocean-light: #2d9e6e;
    --foam: #e8f5ee;
    --foam-dark: #c4e8d4;
    --text: #1a2e24;
    --muted: #5a7a68;
    --white: #ffffff;
    --border: #b0d8bf;
    --radius: 14px;
    --bubble-r: 18px 18px 4px 18px;
    --bubble-l: 18px 18px 18px 4px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #0a1f14 0%, #0d3322 50%, #0a2d4e 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }

  /* â”€â”€ App shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .app {
    width: 100%;
    max-width: 720px;
    height: 90vh;
    max-height: 820px;
    background: var(--white);
    border-radius: 20px;
    box-shadow: 0 32px 80px rgba(0,0,0,.5);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header {
    background: linear-gradient(135deg, var(--ocean) 0%, #0d5236 100%);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    flex-shrink: 0;
  }

  .avatar {
    width: 46px;
    height: 46px;
    background: linear-gradient(135deg, var(--ocean-light) 0%, #4ecb8d 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
    box-shadow: 0 0 0 3px rgba(255,255,255,.2);
  }

  .header-info h1 {
    color: var(--white);
    font-size: 17px;
    font-weight: 700;
    letter-spacing: -.2px;
  }

  .header-info .sub {
    color: #7de0aa;
    font-size: 12px;
    margin-top: 2px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 7px;
    height: 7px;
    background: #4ecb8d;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%,100% { opacity: 1; }
    50% { opacity: .4; }
  }

  .header-badge {
    margin-left: auto;
    background: rgba(255,255,255,.12);
    color: #7de0aa;
    font-size: 10px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    letter-spacing: .3px;
    text-transform: uppercase;
    border: 1px solid rgba(78,203,141,.3);
  }

  /* â”€â”€ Messages area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px 16px;
    background: #f0f7f3;
    scroll-behavior: smooth;
  }

  .messages::-webkit-scrollbar { width: 5px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--foam-dark); border-radius: 10px; }

  /* â”€â”€ Message bubbles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .msg { display: flex; gap: 8px; margin-bottom: 16px; align-items: flex-end; }
  .msg.user { flex-direction: row-reverse; }

  .msg-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
  }

  .msg.assistant .msg-avatar { background: linear-gradient(135deg, var(--ocean-light), #4ecb8d); }
  .msg.user .msg-avatar { background: #dce8e2; font-size: 12px; color: var(--muted); font-weight: 600; }

  .bubble {
    max-width: 75%;
    padding: 11px 15px;
    font-size: 13.5px;
    line-height: 1.55;
    color: var(--text);
    position: relative;
  }

  .msg.assistant .bubble {
    background: var(--white);
    border-radius: var(--bubble-l);
    box-shadow: 0 1px 4px rgba(0,0,0,.08);
  }

  .msg.user .bubble {
    background: var(--ocean);
    color: var(--white);
    border-radius: var(--bubble-r);
  }

  /* Impact report styling inside bubble */
  .bubble .report-box {
    background: var(--foam);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 12px;
    margin: 8px 0 4px;
    font-size: 12.5px;
  }

  .bubble .report-box .report-title {
    font-weight: 700;
    color: var(--ocean);
    font-size: 13px;
    margin-bottom: 6px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }

  .bubble .report-box .row {
    display: flex;
    gap: 6px;
    margin: 3px 0;
    align-items: flex-start;
  }

  .bubble .report-box .row .icon { flex-shrink: 0; width: 16px; }

  .bubble pre {
    background: #f0f7f3;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 12px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
    font-family: 'Courier New', monospace;
    margin: 6px 0;
    color: var(--text);
  }

  /* â”€â”€ Typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .typing {
    display: flex;
    gap: 8px;
    align-items: flex-end;
    margin-bottom: 16px;
  }

  .typing-bubble {
    background: var(--white);
    border-radius: var(--bubble-l);
    padding: 12px 16px;
    box-shadow: 0 1px 4px rgba(0,0,0,.08);
    display: flex;
    gap: 5px;
    align-items: center;
  }

  .dot {
    width: 7px;
    height: 7px;
    background: var(--ocean-light);
    border-radius: 50%;
    animation: bounce .9s infinite;
  }
  .dot:nth-child(2) { animation-delay: .15s; }
  .dot:nth-child(3) { animation-delay: .3s; }

  @keyframes bounce {
    0%,60%,100% { transform: translateY(0); }
    30% { transform: translateY(-6px); }
  }

  /* â”€â”€ Input area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .input-area {
    background: var(--white);
    border-top: 1px solid var(--border);
    padding: 14px 16px;
    flex-shrink: 0;
  }

  .input-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  .input-wrap {
    flex: 1;
    background: var(--foam);
    border: 1.5px solid var(--border);
    border-radius: 22px;
    display: flex;
    align-items: center;
    padding: 0 14px;
    transition: border-color .2s;
  }

  .input-wrap:focus-within {
    border-color: var(--ocean-light);
    box-shadow: 0 0 0 3px rgba(45,158,110,.12);
  }

  textarea {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    font-family: inherit;
    font-size: 14px;
    color: var(--text);
    resize: none;
    padding: 11px 0;
    max-height: 100px;
    line-height: 1.4;
  }

  textarea::placeholder { color: var(--muted); }

  .send-btn {
    width: 42px;
    height: 42px;
    background: var(--ocean);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background .2s, transform .1s;
    flex-shrink: 0;
  }

  .send-btn:hover { background: var(--ocean-mid); }
  .send-btn:active { transform: scale(.93); }
  .send-btn:disabled { background: #b0c4bb; cursor: not-allowed; }

  .send-btn svg { width: 18px; height: 18px; fill: white; }

  /* â”€â”€ Footer disclaimer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .disclaimer {
    text-align: center;
    font-size: 10px;
    color: var(--muted);
    margin-top: 8px;
    padding: 0 8px;
  }

  /* â”€â”€ API key modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    border-radius: 20px;
    padding: 20px;
  }

  .modal {
    background: var(--white);
    border-radius: 16px;
    padding: 28px;
    max-width: 380px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0,0,0,.3);
  }

  .modal h2 {
    color: var(--ocean);
    font-size: 18px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .modal p {
    color: var(--muted);
    font-size: 13px;
    line-height: 1.5;
    margin-bottom: 16px;
  }

  .modal input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 11px 14px;
    font-size: 14px;
    font-family: 'Courier New', monospace;
    color: var(--text);
    outline: none;
    margin-bottom: 12px;
    letter-spacing: .5px;
    transition: border-color .2s;
  }

  .modal input:focus {
    border-color: var(--ocean-light);
    box-shadow: 0 0 0 3px rgba(45,158,110,.12);
  }

  .modal button {
    width: 100%;
    background: var(--ocean);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background .2s;
  }

  .modal button:hover { background: var(--ocean-mid); }

  .modal .note {
    background: var(--foam);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 11.5px;
    color: var(--muted);
    margin-top: 10px;
    line-height: 1.4;
  }

  .modal .note strong { color: var(--ocean); }

  /* â”€â”€ Quick prompts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .quick-prompts {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 10px;
  }

  .quick-btn {
    background: var(--foam);
    border: 1px solid var(--border);
    color: var(--ocean);
    font-size: 11.5px;
    padding: 5px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-family: inherit;
    transition: all .15s;
    white-space: nowrap;
  }

  .quick-btn:hover {
    background: var(--ocean);
    color: white;
    border-color: var(--ocean);
  }

  /* Markdown-style formatting */
  .bubble strong { font-weight: 700; }
  .bubble em { font-style: italic; color: var(--muted); }

  .msg-time {
    font-size: 10px;
    color: #aaa;
    margin-top: 4px;
    text-align: right;
    padding: 0 4px;
  }

  .msg.assistant .msg-time { text-align: left; }
</style>
</head>
<body>

<div class="app" id="app">

  <!-- API Key Modal -->
  <div class="modal-overlay" id="keyModal">
    <div class="modal">
      <h2>ğŸŒŠ Welcome to Marina</h2>
      <p>Marina is TidePool's AI-powered Donor Impact Intelligence Agent. To start a conversation, enter your Anthropic API key below â€” it stays in your browser session only and is never stored.</p>
      <input type="password" id="apiKeyInput" placeholder="Paste your API key here" autocomplete="off" />
      <button onclick="startSession()">Start Conversation with Marina</button>
      <div class="note">
        <strong>Privacy:</strong> Your key is saved in your browser (localStorage) so you only need to enter it once. It is never sent to any server other than Anthropic's API. &nbsp;|&nbsp; Get a key at <strong>console.anthropic.com</strong>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="avatar">ğŸŒŠ</div>
    <div class="header-info">
      <h1>Marina</h1>
      <div class="sub">
        <div class="status-dot"></div>
        TidePool Donor Impact Intelligence Agent
      </div>
    </div>
    <div class="header-badge">claude-sonnet-4-6</div>
  </div>

  <!-- Messages -->
  <div class="messages" id="messages"></div>

  <!-- Input area -->
  <div class="input-area">
    <div class="quick-prompts" id="quickPrompts">
      <button class="quick-btn" onclick="sendQuick(this)">Where did my donation go?</button>
      <button class="quick-btn" onclick="sendQuick(this)">What data do you hold about me?</button>
      <button class="quick-btn" onclick="sendQuick(this)">What would â‚¬5/month achieve?</button>
      <button class="quick-btn" onclick="sendQuick(this)">Show my impact report</button>
    </div>
    <div class="input-row">
      <div class="input-wrap">
        <textarea id="userInput" rows="1" placeholder="Ask Marina about your impactâ€¦"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      </div>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
    <div class="disclaimer">Marina is an AI. Responses are informational. &nbsp;|&nbsp; <a href="https://tidepool.org/privacy" style="color:var(--ocean-light)">Privacy</a> &nbsp;|&nbsp; EX2 Assignment Demo â€” TidePool Ã— Claude Sonnet 4.6</div>
  </div>

</div>

<script>
// â”€â”€â”€ TidePool Impact Database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DONOR = {
  first_name: "Sarah",
  last_name: "M.",
  donation_amount_eur: 12,
  campaign: "Azores Deep Reef Restoration 2024",
  donation_date: "3 February 2026",
  donation_id: "TP-2026-00847",
  is_recurring: false,
  data_held: ["First name and initial","Email address","Donation amount and date","Campaign selected","Payment method type only (not card number)","Country of residence"],
  legal_basis: "Legitimate interest (donation processing and impact reporting)",
  impact: "Your â‚¬12 contributed to protecting approximately 0.21 mÂ² of Azores reef â€” about the size of an A4 notebook page. At â‚¬57.55/mÂ², this is your proportional share of the 847 mÂ² restored to date across 312 donors."
};

const CAMPAIGN = {
  name: "Azores Deep Reef Restoration 2024",
  location: "Azores Archipelago, Portugal (38.7Â°N, 27.1Â°W)",
  status: "Active â€” Phase 2 of 3",
  total_raised_eur: 48750,
  total_donors: 312,
  cost_per_m2: 57.55,
  outcomes: {
    reef_area_m2: 847,
    coral_fragments: 2340,
    fish_species: 23,
    diver_hours: 1840,
    co2_kg: 1250,
    protected_area_m2: 12000
  },
  next_milestone: "Phase 3 coral transplantation â€” April 2026",
  last_survey: "January 2026",
  report_url: "https://tidepool.org/impact/azores-reef-2024",
  financials: { conservation: 78, research: 14, admin: 8 }
};

// â”€â”€â”€ System Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SYSTEM_PROMPT = `You are Marina, TidePool's Donor Impact Intelligence Agent â€” a specialist AI built to restore and strengthen donor trust through radical transparency about conservation outcomes, ethical AI disclosure, and personalised impact reporting.

IDENTITY & PERSONALITY:
- Name: Marina | Role: Donor Impact Intelligence Agent | Organisation: TidePool
- Warm, knowledgeable, and genuinely passionate about marine conservation
- Honest, specific, and evidence-driven â€” never use vague language like "your donation helped the ocean"
- Always acknowledge your AI nature proactively and warmly
- Speak with authority about conservation outcomes but humility about uncertainty

DOMAIN EXPERTISE:
- Marine conservation project metrics (reef area in mÂ², coral fragments, species monitoring, COâ‚‚ sequestration)
- Donation impact quantification and attribution (cost-per-mÂ², donor contribution share)
- GDPR / data privacy rights (Articles 13, 15, 17, 22)
- Ethical AI disclosure in fundraising contexts
- Donor engagement and recurring giving psychology

COMMUNICATION STYLE:
- Lead with verified facts and specific numbers from the donor context provided
- Use tangible real-world analogies (e.g. "0.21 mÂ² â€” about the size of an A4 notebook page")
- Warm but professional â€” use the donor's first name
- Keep responses focused and concise â€” use structured formatting where helpful

WHAT MARINA WILL ALWAYS DO:
âœ“ Open every NEW conversation (first message only) with the transparency declaration
âœ“ Provide specific, numerically precise impact reports
âœ“ Attribute each donation to a concrete, proportional conservation outcome
âœ“ Proactively explain data usage and offer opt-out when privacy is mentioned
âœ“ Enumerate GDPR rights (Articles 13, 15, 17, 22) when data queries arise
âœ“ Connect repeat giving to specific future outcomes, not generic "more impact"
âœ“ Disclose being AI-generated and subject to human oversight

WHAT MARINA WILL NEVER DO:
âœ— Fabricate conservation statistics or donation figures
âœ— Impersonate a human staff member or conceal being an AI
âœ— Apply pressure, urgency, or false scarcity around giving
âœ— Collect or request personal data beyond what is in the donor record
âœ— Dismiss donor concerns about data privacy or AI ethics
âœ— Produce impact estimates without labelling them as estimates

TRANSPARENCY DECLARATION (use ONLY at the very start of the first response):
"Hi, I'm Marina â€” TidePool's AI-powered Donor Impact Agent. I'm here to show you exactly what your donation achieved and answer any questions about TidePool's work. I should be upfront: I'm an AI, and I use your donor record to personalise this conversation. You can opt out of AI-personalised communications at any time at tidepool.org/privacy."

OUTPUT FORMAT FOR IMPACT REPORTS (use emoji headers and clear structure):
ğŸŒŠ IMPACT REPORT | [Campaign]
ğŸ“ Project + location
ğŸ“Š Your Contribution: specific mÂ² attribution
ğŸŒ¿ Outcomes: bulleted list of key metrics
ğŸ“… Status and next milestone
ğŸ“„ Report URL

For data/privacy queries use:
ğŸ”’ DATA TRANSPARENCY REPORT
ğŸ“‚ Data held (list)
âš–ï¸ Legal basis
ğŸ“‹ GDPR rights (enumerate Articles)
ğŸ¤– AI usage disclosure
ğŸ“© Contact for rights requests

For recurring giving: show specific comparison table (one-off vs monthly in mÂ² and other units). Always explicitly state it is optional with no urgency.

Use markdown formatting (bold, bullet points) in responses where it aids clarity.`;

function getDonorContext() {
  return `\n\n[DONOR CONTEXT â€” use for personalisation]
Donor: ${DONOR.first_name} ${DONOR.last_name}
Donation: â‚¬${DONOR.donation_amount_eur} | Campaign: ${DONOR.campaign}
Date: ${DONOR.donation_date} | Ref: ${DONOR.donation_id}
Recurring: ${DONOR.is_recurring ? 'Yes' : 'No'}

Your Impact Attribution: ${DONOR.impact}

Data Held: ${DONOR.data_held.join(', ')}
Legal Basis: ${DONOR.legal_basis}

Campaign Outcomes (${CAMPAIGN.last_survey} survey):
- Reef area restored: ${CAMPAIGN.outcomes.reef_area_m2} mÂ²
- Coral fragments planted: ${CAMPAIGN.outcomes.coral_fragments}
- Fish species monitored: ${CAMPAIGN.outcomes.fish_species}
- Volunteer diver hours: ${CAMPAIGN.outcomes.diver_hours}
- COâ‚‚ sequestered: ${CAMPAIGN.outcomes.co2_kg} kg
- Marine area protected: ${CAMPAIGN.outcomes.protected_area_m2} mÂ²

Cost/mÂ²: â‚¬${CAMPAIGN.cost_per_m2} | Total donors: ${CAMPAIGN.total_donors} | Total raised: â‚¬${CAMPAIGN.total_raised_eur}
Next Milestone: ${CAMPAIGN.next_milestone}
Financial split: ${CAMPAIGN.financials.conservation}% conservation / ${CAMPAIGN.financials.research}% research / ${CAMPAIGN.financials.admin}% admin
Impact Report: ${CAMPAIGN.report_url}`;
}

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let conversationHistory = [];
let apiKey = '';
let isLoading = false;
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');

// â”€â”€â”€ API Key setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startSession() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (key.length < 20) {
    alert('Please paste your full Anthropic API key.');
    return;
  }
  apiKey = key;
  localStorage.setItem('tp_ak', key);  // persists across sessions
  document.getElementById('keyModal').style.display = 'none';
  greetDonor();
}

document.getElementById('apiKeyInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') startSession();
});

// Check localStorage on load â€” key persists across sessions
window.addEventListener('load', () => {
  const saved = localStorage.getItem('tp_ak');
  if (saved) {
    apiKey = saved;
    document.getElementById('keyModal').style.display = 'none';
    greetDonor();
  }
});

// â”€â”€â”€ Send first greeting to get Marina's opening message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function greetDonor() {
  await callMarina('Hello');
}

// â”€â”€â”€ Message rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function now() {
  return new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
}

function renderText(text) {
  // Convert **bold**, bullet points, and newlines to HTML
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/^[-â€¢]\s+(.+)$/gm, '<li style="margin:2px 0 2px 16px">$1</li>')
    .replace(/(<li.*<\/li>\n?)+/g, m => `<ul style="padding:4px 0">${m}</ul>`)
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');
}

function appendMessage(role, text) {
  const msg = document.createElement('div');
  msg.className = `msg ${role}`;

  const avatarEl = document.createElement('div');
  avatarEl.className = 'msg-avatar';
  avatarEl.textContent = role === 'assistant' ? 'ğŸŒŠ' : 'S';

  const bubbleWrap = document.createElement('div');

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = renderText(text);

  const time = document.createElement('div');
  time.className = 'msg-time';
  time.textContent = now();

  bubbleWrap.appendChild(bubble);
  bubbleWrap.appendChild(time);

  msg.appendChild(avatarEl);
  msg.appendChild(bubbleWrap);
  messagesEl.appendChild(msg);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function showTyping() {
  const el = document.createElement('div');
  el.className = 'typing';
  el.id = 'typing';
  el.innerHTML = `
    <div class="msg-avatar" style="width:30px;height:30px;background:linear-gradient(135deg,#2d9e6e,#4ecb8d);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px">ğŸŒŠ</div>
    <div class="typing-bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
  messagesEl.appendChild(el);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function removeTyping() {
  const el = document.getElementById('typing');
  if (el) el.remove();
}

// â”€â”€â”€ Anthropic API call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callMarina(userMessage) {
  if (isLoading) return;
  isLoading = true;
  sendBtn.disabled = true;

  // Add to history
  conversationHistory.push({ role: 'user', content: userMessage });

  if (userMessage !== 'Hello') {
    appendMessage('user', userMessage);
    // Hide quick prompts after first real message
    document.getElementById('quickPrompts').style.display = 'none';
  }

  showTyping();

  // Detect environment: use proxy server if available, else call Anthropic directly
  const PROXY_BASE = window.location.hostname === 'pramithirks-dev.github.io'
    ? 'https://tidepoolagent.onrender.com'    // Render deployment
    : window.location.origin;                  // Same-origin (local dev / Render)
  const CHAT_ENDPOINT = `${PROXY_BASE}/api/chat`;

  try {
    const headers = { 'Content-Type': 'application/json' };
    // Pass API key as Authorization header to proxy (never stored server-side)
    if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;

    const response = await fetch(CHAT_ENDPOINT, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 1200,
        system: SYSTEM_PROMPT + getDonorContext(),
        messages: conversationHistory
      })
    });

    if (!response.ok) {
      let errMsg = `API error (HTTP ${response.status})`;
      try {
        const errBody = await response.json();
        errMsg = errBody.error?.message || errMsg;
      } catch (_) {}
      if (response.status === 401) {
        errMsg = 'Authentication failed â€” your API key was not accepted. Please check you copied it in full from console.anthropic.com/settings/keys and try again.';
        // Clear invalid key so modal re-appears
        localStorage.removeItem('tp_ak');
        apiKey = '';
        setTimeout(() => { document.getElementById('keyModal').style.display = 'flex'; }, 2000);
      }
      throw new Error(errMsg);
    }

    const data = await response.json();
    const reply = data.content[0].text;

    conversationHistory.push({ role: 'assistant', content: reply });
    removeTyping();
    appendMessage('assistant', reply);

  } catch (err) {
    removeTyping();
    const isCors = err.message === 'Failed to fetch' || err.message.includes('NetworkError');
    const display = isCors
      ? '**Network error.** Your browser blocked the API request. Try opening the page in Chrome or Edge, or disable any browser extensions that block cross-origin requests.'
      : `**Error:** ${err.message}`;
    appendMessage('assistant', display);
    conversationHistory.pop();
  }

  isLoading = false;
  sendBtn.disabled = false;
  inputEl.focus();
}

// â”€â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const text = inputEl.value.trim();
  if (!text || isLoading) return;
  inputEl.value = '';
  autoResize(inputEl);
  await callMarina(text);
}

function sendQuick(btn) {
  if (isLoading) return;
  inputEl.value = btn.textContent;
  sendMessage();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}
</script>
</body>
</html>
